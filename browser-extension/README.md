# 公文系统文献助手 - 浏览器插件

类似 Zotero 的浏览器插件，帮助用户快速保存网页上的 PDF 文档到文献库。

## 功能特性

### 核心功能
- **智能检测PDF**: 在浏览网页时自动检测多种形式的PDF链接：
  - 直接PDF链接（`.pdf`结尾）
  - 下载按钮（通过JavaScript触发）
  - 带有"下载"/"Download"文本的按钮
  - `data-url`、`data-pdf`等属性中的链接
  - iframe中嵌入的PDF
  - 表单下载链接
- **多结果显示**: 检测到多个PDF时，显示列表供选择
- **置信度标记**: 对检测结果进行高/中/低置信度标记
- **手动输入**: 支持手动粘贴PDF链接
- **一键保存**: 点击插件图标快速保存到文献库
- **右键菜单**: 右键点击PDF链接即可保存
- **智能提取**: 自动提取文档标题和元数据
- **本地存储**: 文件保存在本地，索引存储在云端

### 高级功能
- **页面扫描**: 一键扫描当前页面所有PDF链接
- **下载监听**: 自动监听PDF下载并提示保存
- **批量管理**: 配合文献库页面进行批量操作
- **快捷键支持**: 可配置快捷键快速操作
- **桌面通知**: 保存状态实时通知

## 安装方法

### 开发模式安装
1. 打开 Chrome/Edge 浏览器
2. 访问 `chrome://extensions/` (Edge: `edge://extensions/`)
3. 开启"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择 `browser-extension` 文件夹

### 生成PNG图标（可选）
当前使用SVG图标，如需PNG图标：
1. 访问 [icon.svg](icons/icon.svg)
2. 使用在线工具转换: https://cloudconvert.com/svg-to-png
3. 生成 16x16, 48x48, 128x128 三个尺寸
4. 保存为 icon16.png, icon48.png, icon128.png
5. 更新 manifest.json 中的图标引用

## 使用方法

### 方式1: 插件弹窗
1. 访问包含PDF的网页
2. 点击浏览器工具栏的插件图标
3. 确认自动检测的标题（可修改）
4. 点击"保存到文献库"或"下载到本地"

### 方式2: 右键菜单
1. 在PDF链接上右键
2. 选择"📚 保存PDF到文献库"
3. 自动保存并显示通知

### 方式3: 手动输入链接
1. 当自动检测失败时
2. 点击"手动输入PDF链接"
3. 粘贴从网页获取的PDF链接
4. 输入标题（可选）
5. 点击"使用手动输入的链接"

### 方式4: 页面扫描
1. 在任意网页右键
2. 选择"🔍 在当前页面查找PDF"
3. 查看找到的所有PDF链接

### 方式5: 快捷键
1. 在 manifest.json 的 commands 中定义快捷键
2. 使用快捷键快速保存当前PDF或打开文献库

## 配置选项

插件支持以下配置（存储在本地）:
```javascript
{
  autoSave: false,        // 是否自动保存下载的PDF
  defaultFolder: '未分类', // 默认文件夹
  defaultTags: ['网页保存'] // 默认标签
}
```

## API通信

插件与后端API通信:
- **保存文档**: `POST /api/plugin/save`
- **获取文档列表**: `GET /api/documents`
- **更新文档**: `PATCH /api/documents/:id`

## 工作流程

```
用户浏览网页
    ↓
检测PDF链接
    ↓
用户点击保存
    ↓
发送到后端API (/api/plugin/save)
    ↓
保存到Supabase（索引）+ 本地下载（文件）
    ↓
显示通知 + 更新UI
```

## 架构说明

### 文件结构
```
browser-extension/
├── manifest.json       # 插件配置文件
├── background.js       # Service Worker（后台脚本）
├── content.js          # Content Script（页面注入脚本）
├── popup.html          # 弹窗UI
├── popup.js            # 弹窗逻辑
├── icons/              # 图标文件
│   └── icon.svg        # SVG图标
└── README.md           # 说明文档
```

### 各文件职责
- **manifest.json**: 插件配置、权限、声明
- **background.js**: 后台任务、右键菜单、消息处理
- **content.js**: 页面内容检测、PDF标记
- **popup.html/js**: 用户界面、保存操作

## 注意事项

1. **CORS配置**: ���端需要允许来自插件域名的请求
2. **本地存储**: 文件保存在用户选择的本地文件夹
3. **索引存储**: 文档索引存储在 Supabase 数据库
4. **API地址**: 开发时使用 `localhost:5000`，生产环境需修改
5. **隐私安全**: 插件仅在用户主动操作时访问数据

## 常见问题

**Q: 网页只有一个下载按钮，插件检测不到PDF怎么办？**
A: 有几种解决方案：
1. **手动输入链接**：点击插件中的"手动输入PDF链接"，粘贴从开发者工具中获取的URL
2. **使用浏览器开发者工具**：
   - 按F12打开开发者工具
   - 切换到"Network"(网络)标签
   - 点击网页上的下载按钮
   - 在网络请求中找到PDF下载请求
   - 右键复制请求URL
   - 粘贴到插件的手动输入框
3. **右键菜单**：在下载按钮上右键，选择"📚 保存PDF到文献库"

**Q: 为什么有些按钮显示"需手动点击"？**
A: 这些按钮使用JavaScript生成下载链接，无法直接从HTML中提取。需要点击按钮触发下载，然后通过网络请求获取实际URL。

**Q: 保存后在哪里查看文档？**
A: 点击插件底部的"🚀 打开文献库"链接。

**Q: 文件实际存在哪里？**
A: 文件由浏览器下载到本地，插件只保存索引信息。

**Q: 如何批量管理文档？**
A: 使用文献库页面的批量选择功能。

**Q: 插件支持哪些浏览器？**
A: Chrome、Edge、Brave 等 Chromium 浏览器。

**Q: 检测置信度是什么意思？**
A:
- **高置信度**: 确定的PDF链接（.pdf结尾）
- **中置信度**: 可能是下载链接
- **低置信度**: 需要进一步确认

## 开发说明

### 调试方法
- **Background Script**: chrome://extensions/ → 服务进程
- **Popup**: 右键插件图标 → 检查弹出内容
- **Content Script**: 网页 DevTools → Console

### 日志查看
所有 console.log 输出可以在对应的 DevTools 中查看。

### 权限说明
- `activeTab`: 访问当前标签页
- `downloads`: 下载文件到本地
- `storage`: 保存插件配置和数据
- `contextMenus`: 创建右键菜单
- `notifications`: 显示桌面通知
- `scripting`: 注入脚本到页面

## 更新日志

### v1.0.0 (2026-02-26)
- ✨ 初始版本发布
- ✨ 支持PDF检测和保存
- ✨ 右键菜单集成
- ✨ 本地+云端混合存储
- ✨ 文献库页面集成
